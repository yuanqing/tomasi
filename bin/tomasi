#!/usr/bin/env node

'use strict';

var tomasi = require('..');

var dateformat = require('dateformat');
var nopt = require('nopt');

var log = function(msg) {
  var time = dateformat('HH:MM:ss');
  console.log('tomasi · ' + time + ' · ' + msg);
};

var errCb = function(err) {
  log(err);
  process.exit(1);
};

var opts = nopt({
  watch: Boolean
});
var remain = opts.argv.remain;
var config = remain[0] || 'tomasi.js';

try {
  var t = tomasi(config);
} catch (err) {
  return errCb(err);
}

if (opts.watch) {
  var watchOpts = {
    onBuildStart: function() {
      log('Building...');
    },
    onBuildEnd: function(err) {
      if (err) {
        return errCb(err);
      }
      log('Done');
      log('Watching...');
    },
    onChange: function(event) {
      log('File ' + event);
    },
  };
  t.watch(function(err) {
    if (err) {
      return errCb(err);
    }
  }, watchOpts);
} else {
  t.build(function(err) {
    log('Building...');
    if (err) {
      return errCb(err);
    }
    log('Done');
  });
}
