#!/usr/bin/env node

'use strict';

var tomasi = require('..');

var _ = require('savoy');
var dateformat = require('dateformat');
var gaze = require('gaze');
var nopt = require('nopt');

var log = function(msg) {
  var time = dateformat('HH:MM:ss');
  console.log('tomasi · ' + time + ' · ' + msg);
};

var errCb = function(err) {
  log(err);
  process.exit(1);
};

var noop = function() {};

var build = function(t, cb) {
  cb = cb || noop;
  log('Building...');
  t.build(function(err) {
    if (err) return cb(err);
    log('Done');
    cb();
  });
};

var opts = nopt({
  watch: Boolean
});
var remain = opts.argv.remain;
var config = 'tomasi.js';
if (remain && remain[0]) {
  config = remain[0];
}

try {
  var t = tomasi(config);
} catch (err) {
  return errCb(err);
}

build(t, function(err) {
  if (err) return errCb(err);
  if (opts.watch) {
    var inPaths = _.fold(t.config, [], function(acc, dataTypes) {
      acc.push(dataTypes.$in);
      return acc;
    });
    gaze(inPaths, function(err, watcher) {
      if (err) return errCb(err);
      var watchMsg = 'Watching...';
      log(watchMsg);
      watcher.on('all', function(event) {
        log('File ' + event);
        build(t, function(err) {
          if (err) return errCb(err);
          log(watchMsg);
        });
      });
    });
  }
});
